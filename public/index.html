<!DOCTYPE html>
<html lang="de" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <meta name="description" content="HTW Dresden AI Chat Assistant - Dein intelligenter Helfer für alle Fragen rund um die HTW Dresden">
  <meta name="theme-color" content="#3b82f6">
  <title>HTW Dresden AI Chat Assistant</title>
  <script defer src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous">
</head>
<body>
  <header>
    <h1>Alex – HTW Dresden AI Assistant</h1>
    <div class="actions">
      <button id="theme-toggle" title="Theme wechseln"><i class="fas fa-adjust"></i></button>
      <span id="current-time"></span>
      <button id="new-chat" title="Neues Gespräch"><i class="fas fa-plus"></i></button> <button id="settings-btn" title="Einstellungen"><i class="fas fa-cog"></i></button>
    </div>
  </header>
  <div id="main">
    <aside id="threads">
      <h2>Unterhaltungen</h2>
      <div class="thread active">Aktuelles Gespräch</div>
    </aside>
    <section id="chat">
      <div id="messages"></div>
      <div id="typing"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
    </section>
  </div>
  <div id="input">
    <div class="wrapper">
      <textarea id="chat-input" placeholder="Stelle deine Frage..." rows="1"></textarea>
      <button class="send" id="send-btn"><i class="fas fa-paper-plane"></i></button>
    </div>
    <div class="suggest">
      <div class="chip">Stundenplan</div>
      <div class="chip">Urlaubssemester</div>
      <div class="chip">Prüfung</div>
    </div>
  </div>
  <button id="scroll-btn" title="Zum neuesten springen"><i class="fas fa-arrow-down"></i></button>
  <div id="settings-modal">
    <div class="modal-content">
      <h3 class="mb-2 font-medium">Einstellungen</h3>
      <label class="block mb-2">Akzentfarbe: <input type="color" id="accent-color"></label>
      <button id="close-settings" class="send mt-2">Schließen</button>
    </div>
  </div>
  <script>
    const root = document.documentElement;
    const themeToggle = document.getElementById('theme-toggle');
    const currentTimeEl = document.getElementById('current-time');
    const threadsEl = document.getElementById('threads');
    const messagesEl = document.getElementById('messages');
    const chatInput = document.getElementById('chat-input');
    const sendBtnEl = document.getElementById('send-btn');
    const typingEl = document.getElementById('typing');
    const scrollBtnEl = document.getElementById('scroll-btn');
    const suggestionChips = document.querySelectorAll('.chip');
    let conversationId = null;

    const settingsBtn = document.getElementById("settings-btn");
    const settingsModal = document.getElementById("settings-modal");
    const closeSettings = document.getElementById("close-settings");
    const accentColorInput = document.getElementById("accent-color");
    // Update clock every minute
    function updateClock() {
      currentTimeEl.textContent = new Date().toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
    }
    setInterval(updateClock, 1000);
    updateClock();

    // Theme toggle
    themeToggle.addEventListener('click', () => {
      const next = root.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      root.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
    });
    const saved = localStorage.getItem('theme');
    if (saved) root.setAttribute('data-theme', saved);

    // Scroll handling
    const savedAccent = localStorage.getItem("accent");
    if (savedAccent) {
      root.style.setProperty("--accent", savedAccent);
      accentColorInput.value = savedAccent;
    }
    settingsBtn.addEventListener("click", () => settingsModal.classList.add("open"));
    closeSettings.addEventListener("click", () => settingsModal.classList.remove("open"));
    settingsModal.addEventListener("click", e => { if (e.target === settingsModal) settingsModal.classList.remove("open"); });
    accentColorInput.addEventListener("input", () => {
      root.style.setProperty("--accent", accentColorInput.value);
      localStorage.setItem("accent", accentColorInput.value);
    });
    function scrollToBottom() {
      scrollBtnEl.style.display = 'none';
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }
    messagesEl.addEventListener('scroll', () => {
      const distance = messagesEl.scrollHeight - messagesEl.scrollTop - messagesEl.clientHeight;
      scrollBtnEl.style.display = distance > 100 ? 'block' : 'none';
    });
    scrollBtnEl.addEventListener('click', scrollToBottom);

    // Auto-resize input
    chatInput.addEventListener('input', () => {
      chatInput.style.height = 'auto';
      chatInput.style.height = `${chatInput.scrollHeight}px`;
    });

    // Add a message to the chat
    function addMsg(text, isUser, timestamp, copyable = false) {
      const m = document.createElement('div');
      m.className = `message ${isUser ? 'user' : 'ai'}`;

      const avatar = document.createElement('div');
      avatar.className = 'avatar';
      avatar.innerHTML = `<i class="fas ${isUser ? 'fa-user' : 'fa-robot'}"></i>`;
      m.appendChild(avatar);

      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.innerHTML = text;

      if (!isUser && copyable) {
        const c = document.createElement('span');
        c.className = 'copy-btn';
        c.innerHTML = '<i class="fas fa-copy"></i>';
        c.addEventListener('click', () => navigator.clipboard.writeText(text));
        bubble.appendChild(c);
      }

      const md = document.createElement('div');
      md.className = 'metadata';
      md.textContent = new Date(timestamp).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
      bubble.appendChild(md);

      m.appendChild(bubble);
      messagesEl.appendChild(m);
      scrollToBottom();
    }

    // Load conversation threads
    async function loadThreads() {
      try {
        const res = await fetch('https://dev.olomek.com/api/threads');
        const threads = await res.json();
        threadsEl.innerHTML = '<h2>Unterhaltungen</h2>';
        threads.forEach(thread => {
          const t = document.createElement('div');
          t.className = `thread ${thread.conversationId === conversationId ? 'active' : ''}`;
          t.textContent = thread.title || `Gespräch ${thread.conversationId.slice(0, 8)}`;
          t.dataset.conversationId = thread.conversationId;
          t.addEventListener('click', () => loadConversation(thread.conversationId));
          threadsEl.appendChild(t);
        });
      } catch (e) {
        console.error('Fehler beim Laden der Threads:', e);
      }
    }

    // Load messages for a conversation
    async function loadConversation(id) {
      conversationId = id;
      messagesEl.innerHTML = '';
      document.querySelectorAll('.thread').forEach(t => t.classList.remove('active'));
      document.querySelector(`.thread[data-conversation-id="${id}"]`).classList.add('active');
      try {
        const res = await fetch(`https://dev.olomek.com/api/threads/${id}`);
        const conversation = await res.json();
        conversation.messages.forEach(msg => {
          addMsg(msg.text, msg.isUser, msg.timestamp, !msg.isUser);
        });
      } catch (e) {
        console.error('Fehler beim Laden der Konversation:', e);
        addMsg('Fehler beim Laden der Konversation.', false);
      }
    }

    // New chat handler
    document.getElementById('new-chat').addEventListener('click', async () => {
      messagesEl.innerHTML = '';
      conversationId = null;
      document.querySelectorAll('.thread').forEach(t => t.classList.remove('active'));
      const t = document.createElement('div');
      t.className = 'thread active';
      t.textContent = 'Neues Gespräch';
      t.dataset.conversationId = '';
      t.addEventListener('click', () => loadConversation(null));
      threadsEl.appendChild(t);
      addMsg('Neues Gespräch gestartet. Wie kann ich helfen?', false);
      await loadThreads(); // Refresh thread list
    });

    // Send message logic
    async function sendMsg(prefilled) {
      const txt = prefilled || chatInput.value.trim();
      if (!txt) return;
      addMsg(txt, true, new Date());
      chatInput.value = '';
      chatInput.disabled = true;
      sendBtnEl.disabled = true;
      typingEl.style.display = 'flex';
      try {
        const res = await fetch('https://dev.olomek.com/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt: txt, conversationId })
        });
        const data = await res.json();
        conversationId = data.conversationId;
        addMsg(data.response, false, new Date(), true);
        await loadThreads(); // Refresh thread list
      } catch (e) {
        addMsg('Fehler beim Server.', false);
        console.error(e);
      } finally {
        typingEl.style.display = 'none';
        chatInput.disabled = false;
        sendBtnEl.disabled = false;
        chatInput.focus();
      }
    }

    // Event listeners
    sendBtnEl.addEventListener('click', () => sendMsg());
    chatInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMsg();
      }
    });
    suggestionChips.forEach(c => c.addEventListener('click', () => sendMsg(c.textContent)));

    // Initial setup
    loadThreads();
    addMsg('Hallo! Ich bin Alex, dein AI-Assistent der HTW Dresden. Wie kann ich dir helfen?', false);
  </script>
</body>
</html>