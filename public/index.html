<!DOCTYPE html>
<html lang="de" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <meta name="description" content="HTW Dresden AI Chat Assistant - Dein intelligenter Helfer für alle Fragen rund um die HTW Dresden">
  <meta name="theme-color" content="#3b82f6">
  <title>HTW Dresden AI Chat Assistant</title>
  <script defer src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous">
  <style>
    /* Theme Variables */
[data-theme="light"] { --bg: #f8fafc; --fg: #1f2937; --border: #e5e7eb; --accent: #3b82f6; }
[data-theme="dark"]  { --bg: #1a1a2e; --fg: #f3f4f6; --border: #374151; --accent: #3b82f6; }
* { box-sizing: border-box; }
body { margin: 0; height: 100vh; display: grid; grid-template-rows: auto 1fr auto; background: var(--bg); color: var(--fg); font-family: 'Inter', sans-serif; }
header { grid-row: 1; display: flex; justify-content: space-between; align-items: center; padding: 1rem 2rem; background: var(--accent); color: white; }
header h1 { font-size: 1.5rem; font-weight: 600; margin: 0; }
.actions { display: flex; gap: 1rem; align-items: center; }
.actions button { background: transparent; border: none; color: white; font-size: 1.25rem; cursor: pointer; transition: transform .2s; }
.actions button:hover { transform: scale(1.1); }
#main { grid-row: 2; display: grid; grid-template-columns: 300px 1fr; height: 100%; overflow: hidden; }
@media (max-width: 768px) { #main { grid-template-columns: 1fr; } }
#threads { background: var(--bg); border-right: 1px solid var(--border); padding: 1rem; overflow-y: auto; }
#threads h2 { margin: 0 0 1rem; font-size: 1.125rem; font-weight: 500; }
.thread { display: flex; justify-content: space-between; align-items: center; padding: .75rem 1rem; border-radius: .75rem; cursor: pointer; transition: background .2s, color .2s; }
.thread.active, .thread:hover { background: var(--accent); color: white; }
@media (max-width: 768px) { #threads { display: none; } }
#chat { display: flex; flex-direction: column; background: var(--bg); position: relative; height: 100%; min-height: 0; }
#messages { flex: 1 1 auto; overflow-y: auto; padding: 1.5rem; display: flex; flex-direction: column; gap: 1rem; scroll-behavior: smooth; min-height: 0; }
.message { position: relative; max-width: 70%; padding: 1rem 1.25rem; border-radius: 1rem; line-height: 1.5; background: var(--border); transition: transform .2s; }
.message:hover { transform: translateY(-2px); }
.message.user { margin-left: auto; background: var(--accent); color: white; border-bottom-right-radius: .25rem; }
.message.ai { margin-right: auto; background: var(--bg); border: 1px solid var(--border); color: var(--fg); border-bottom-left-radius: .25rem; }
.metadata { font-size: .75rem; opacity: .6; margin-top: .5rem; text-align: right; }
.copy-btn { position: absolute; top: .5rem; right: .5rem; opacity: .4; cursor: pointer; transition: opacity .2s; }
.copy-btn:hover { opacity: 1; }
#typing { display: none; align-items: center; padding: .75rem 1.5rem; }
.dot { width: 8px; height: 8px; background: var(--accent); border-radius: 50%; margin: 0 4px; animation: bounce 1.2s infinite; }
.dot:nth-child(2) { animation-delay: .2s; }
.dot:nth-child(3) { animation-delay: .4s; }
@keyframes bounce { 0%, 80%, 100% { transform: translateY(0); } 40% { transform: translateY(-6px); } }
#scroll-btn { position: fixed; bottom: 3rem; right: 2rem; background: var(--accent); color: white; border: none; border-radius: 50%; padding: .75rem; cursor: pointer; display: none; box-shadow: 0 2px 6px rgba(0,0,0,0.2); transition: transform .2s; }
#scroll-btn:hover { transform: scale(1.1); }
#input { grid-row: 3; background: var(--bg); border-top: 1px solid var(--border); padding: 1rem 2rem; }
@media (max-width: 768px) { #input { padding: .75rem 1rem; } }
.wrapper { max-width: 900px; margin: 0 auto; display: flex; gap: .75rem; align-items: center; }
@media (max-width: 768px) { .wrapper { flex-direction: column; align-items: stretch; gap: .5rem; } }
#chat-input { flex: 1; padding: .75rem 1rem; border: 1px solid var(--border); border-radius: .75rem; resize: none; min-height: 2.5rem; font-size: .95rem; }
button.send { background: var(--accent); color: white; padding: .75rem 1.5rem; border: none; border-radius: .75rem; cursor: pointer; font-weight: 500; transition: transform .2s; }
button.send:hover { transform: translateY(-2px); }
.suggest { display: flex; justify-content: center; gap: .5rem; margin-top: .75rem; flex-wrap: wrap; }
.chip { background: var(--border); padding: .5rem 1rem; border-radius: 9999px; cursor: pointer; transition: transform .2s; }
.chip:hover { background: var(--accent); color: white; transform: scale(1.05); }
  </style>
</head>
<body>
  <header>
    <h1>Alex – HTW Dresden AI Assistant</h1>
    <div class="actions">
      <button id="theme-toggle" title="Theme wechseln"><i class="fas fa-adjust"></i></button>
      <span id="current-time"></span>
      <button id="new-chat" title="Neues Gespräch"><i class="fas fa-plus"></i></button>
    </div>
  </header>
  <div id="main">
    <aside id="threads">
      <h2>Unterhaltungen</h2>
      <div class="thread active">Aktuelles Gespräch</div>
    </aside>
    <section id="chat">
      <div id="messages"></div>
      <div id="typing"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
    </section>
  </div>
  <div id="input">
    <div class="wrapper">
      <textarea id="chat-input" placeholder="Stelle deine Frage..." rows="1"></textarea>
      <button class="send" id="send-btn"><i class="fas fa-paper-plane"></i></button>
    </div>
    <div class="suggest">
      <div class="chip">Stundenplan</div>
      <div class="chip">Urlaubssemester</div>
      <div class="chip">Prüfung</div>
    </div>
  </div>
  <button id="scroll-btn" title="Zum neuesten springen"><i class="fas fa-arrow-down"></i></button>
  <script>
    const root = document.documentElement;
    const themeToggle = document.getElementById('theme-toggle');
    const currentTimeEl = document.getElementById('current-time');
    const threadsEl = document.getElementById('threads');
    const messagesEl = document.getElementById('messages');
    const chatInput = document.getElementById('chat-input');
    const sendBtnEl = document.getElementById('send-btn');
    const typingEl = document.getElementById('typing');
    const scrollBtnEl = document.getElementById('scroll-btn');
    const suggestionChips = document.querySelectorAll('.chip');
    let conversationId = null;

    // Update clock every minute
    function updateClock() {
      currentTimeEl.textContent = new Date().toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
    }
    setInterval(updateClock, 1000);
    updateClock();

    // Theme toggle
    themeToggle.addEventListener('click', () => {
      const next = root.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      root.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
    });
    const saved = localStorage.getItem('theme');
    if (saved) root.setAttribute('data-theme', saved);

    // Scroll handling
    function scrollToBottom() {
      scrollBtnEl.style.display = 'none';
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }
    messagesEl.addEventListener('scroll', () => {
      const distance = messagesEl.scrollHeight - messagesEl.scrollTop - messagesEl.clientHeight;
      scrollBtnEl.style.display = distance > 100 ? 'block' : 'none';
    });
    scrollBtnEl.addEventListener('click', scrollToBottom);

    // Auto-resize input
    chatInput.addEventListener('input', () => {
      chatInput.style.height = 'auto';
      chatInput.style.height = `${chatInput.scrollHeight}px`;
    });

    // Add a message to the chat
    function addMsg(text, isUser, timestamp, copyable = false) {
      const m = document.createElement('div');
      m.className = `message ${isUser ? 'user' : 'ai'}`;
      m.innerHTML = `<div>${text}</div>`;
      if (!isUser && copyable) {
        const c = document.createElement('span');
        c.className = 'copy-btn';
        c.innerHTML = '<i class="fas fa-copy"></i>';
        c.addEventListener('click', () => navigator.clipboard.writeText(text));
        m.appendChild(c);
      }
      const md = document.createElement('div');
      md.className = 'metadata';
      md.textContent = new Date(timestamp).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
      m.appendChild(md);
      messagesEl.appendChild(m);
      scrollToBottom();
    }

    // Load conversation threads
    async function loadThreads() {
      try {
        const res = await fetch('https://dev.olomek.com/api/threads');
        const threads = await res.json();
        threadsEl.innerHTML = '<h2>Unterhaltungen</h2>';
        threads.forEach(thread => {
          const t = document.createElement('div');
          t.className = `thread ${thread.conversationId === conversationId ? 'active' : ''}`;
          t.textContent = thread.title || `Gespräch ${thread.conversationId.slice(0, 8)}`;
          t.dataset.conversationId = thread.conversationId;
          t.addEventListener('click', () => loadConversation(thread.conversationId));
          threadsEl.appendChild(t);
        });
      } catch (e) {
        console.error('Fehler beim Laden der Threads:', e);
      }
    }

    // Load messages for a conversation
    async function loadConversation(id) {
      conversationId = id;
      messagesEl.innerHTML = '';
      document.querySelectorAll('.thread').forEach(t => t.classList.remove('active'));
      document.querySelector(`.thread[data-conversation-id="${id}"]`).classList.add('active');
      try {
        const res = await fetch(`https://dev.olomek.com/api/threads/${id}`);
        const conversation = await res.json();
        conversation.messages.forEach(msg => {
          addMsg(msg.text, msg.isUser, msg.timestamp, !msg.isUser);
        });
      } catch (e) {
        console.error('Fehler beim Laden der Konversation:', e);
        addMsg('Fehler beim Laden der Konversation.', false);
      }
    }

    // New chat handler
    document.getElementById('new-chat').addEventListener('click', async () => {
      messagesEl.innerHTML = '';
      conversationId = null;
      document.querySelectorAll('.thread').forEach(t => t.classList.remove('active'));
      const t = document.createElement('div');
      t.className = 'thread active';
      t.textContent = 'Neues Gespräch';
      t.dataset.conversationId = '';
      t.addEventListener('click', () => loadConversation(null));
      threadsEl.appendChild(t);
      addMsg('Neues Gespräch gestartet. Wie kann ich helfen?', false);
      await loadThreads(); // Refresh thread list
    });

    // Send message logic
    async function sendMsg(prefilled) {
      const txt = prefilled || chatInput.value.trim();
      if (!txt) return;
      addMsg(txt, true, new Date());
      chatInput.value = '';
      chatInput.disabled = true;
      sendBtnEl.disabled = true;
      typingEl.style.display = 'flex';
      try {
        const res = await fetch('https://dev.olomek.com/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt: txt, conversationId })
        });
        const data = await res.json();
        conversationId = data.conversationId;
        addMsg(data.response, false, new Date(), true);
        await loadThreads(); // Refresh thread list
      } catch (e) {
        addMsg('Fehler beim Server.', false);
        console.error(e);
      } finally {
        typingEl.style.display = 'none';
        chatInput.disabled = false;
        sendBtnEl.disabled = false;
        chatInput.focus();
      }
    }

    // Event listeners
    sendBtnEl.addEventListener('click', () => sendMsg());
    chatInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMsg();
      }
    });
    suggestionChips.forEach(c => c.addEventListener('click', () => sendMsg(c.textContent)));

    // Initial setup
    loadThreads();
    addMsg('Hallo! Ich bin Alex, dein AI-Assistent der HTW Dresden. Wie kann ich dir helfen?', false);
  </script>
</body>
</html>